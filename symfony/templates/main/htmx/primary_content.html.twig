<div id="filtersModal" class="modal fade" tabindex="-1" aria-labelledby="filtersTitle" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div id="filters-top" class="modal-content">
            <div class="modal-header">
                <h5 id="filtersTitle" class="modal-title">
                    Filters
                </h5>

                <span><button type="button" class="btn btn-primary" data-bs-dismiss="modal">Apply</button></span>
            </div>

            {% set filter_choices = {
                'countries': {'label': 'Countries', 'body': 'CountriesFilter', 'help': 'CountriesHelp', 'data': filters.countries},
                'states': {'label': 'States', 'body': 'MultiselectFilter', 'help': 'StatesHelp', 'data': filters.states},
                'languages': {'label': 'Languages', 'body': 'MultiselectFilter', 'help': 'LanguagesHelp', 'data': filters.languages},
                'styles': {'label': 'Styles', 'body': 'MultiselectFilter', 'help': 'StylesHelp', 'data': filters.styles},
                'features': {'label': 'Features', 'body': 'MultiselectFilter', 'help': 'FeaturesHelp', 'data': filters.features, 'is_and': true},
                'orderTypes': {'label': 'Order types', 'body': 'MultiselectFilter', 'help': 'OrderTypesHelp', 'data': filters.orderTypes},
                'productionModels': {'label': 'Production models', 'body': 'MultiselectFilter', 'help': 'ProductionModelsHelp', 'data': filters.productionModels},
                'openFor': {'label': 'Open for', 'body': 'MultiselectFilter', 'help': 'OpenForHelp', 'data': filters.openFor},
                'species': {'label': 'Species', 'body': 'SpeciesFilter', 'help': 'SpeciesHelp', 'data': filters.species},
                'paymentPlans': {'label': 'Payment plans', 'body': 'MultiselectFilter', 'help': 'PaymentPlansHelp', 'data': filters.paymentPlans},
                'inactive': {'label': 'Hidden', 'body': 'MultiselectFilter', 'help': 'InactiveHelp', 'data': filters.inactive},
            } %}

            <div id="filters-body" class="modal-body">
                <div class="row">
                    <div class="col">
                        {% for filter_name, filter in filter_choices %}
                            <div id="filter-ctrl-{{ filter_name }}" class="btn-group my-1" role="group">
                                <button class="btn btn-outline-secondary"
                                        data-bs-target="#filter-body-{{ filter_name }}"
                                        data-bs-toggle="collapse">
                                    {{ filter.label }}: {# { filter.state.description } #}
                                </button>
                                {#    <button v-if="filter.state.isActive" type="button" class="filter-ctrl-remove btn btn-outline-danger" @click="filter.state.reset()"> #}
                                {#        <i class="fas fa-trash-alt"/> #}
                                {#    </button> #}
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <form id="filters">
                    <BodyContainer v-for="filter in filters" :key="filter.groupName" :filter="filter"></BodyContainer> {# FIXME #}
                </form>
            </div>
        </div>
    </div>
</div>

{# FIXME
<div v-if="aasConfig.getMakerMode()" class="card border-danger mb-3">
    <div class="card-header">
        Filters disabled
    </div>
    <div class="card-body">
        <p class="card-text">
            All filtering has been temporarily disabled to ease searching the whole database. Use the below button
            to restore them.
        </p>
        <a id="btn-reenable-filters" :href="Static.getMainPath()" class="btn btn-light btn-outline-danger"
           @click="disableMakerMode">Re-enable filters</a>
    </div>
</div>
#}

<div id="artisanUpdatesModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div id="artisanUpdatesModalContent" class="modal-content">
        </div>
    </div>
</div>

<div id="artisanDetailsModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div id="artisanDetailsModalContent" class="modal-content {# TODO artisan-data #}"></div>
    </div>
</div>

{# TODO: Visibility #}
{% set columns = {
    makerId:          {label: 'Maker ID',          alignment_class: 'text-center', default_visibility: false},
    state:            {label: 'State',             alignment_class: 'text-center', default_visibility: false},
    languages:        {label: 'Languages',         alignment_class: 'text-center', default_visibility: false},
    productionModels: {label: 'Production models', alignment_class: 'text-center', default_visibility: false},
    styles:           {label: 'Styles',            alignment_class: 'text-center', default_visibility: true},
    types:            {label: 'Types',             alignment_class: 'text-center', default_visibility: false},
    features:         {label: 'Features',          alignment_class: 'text-center', default_visibility: false},
    species:          {label: 'Species',           alignment_class: 'text-center', default_visibility: false},
    commissions:      {label: 'Commissions',       alignment_class: 'text-center', default_visibility: true},
    links:            {label: 'Links',             alignment_class: 'text-end',    default_visibility: true},
} %}

<div id="data-table-container">
    <div class="row">
        <div class="col-md-6">
            <div class="btn-group mb-2" role="group" aria-label="Menus and legend">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-dark dropdown-toggle" data-bs-toggle="dropdown"
                            data-bs-auto-close="outside" aria-expanded="false">
                        Columns
                    </button>
                    <ul class="dropdown-menu">
                        {% for column_id, column in columns %}
                            <li>
                                <a class="dropdown-item {% if column.default_visibility %}active{% endif %}" {# FIXME visitility #}
                                   href="#">{{ column.label }}</a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                <button id="filtersButton" type="button" class="btn btn-success text-nowrap" data-bs-toggle="modal"
                        data-bs-target="#filtersModal">
                    Filters
                    {% if active_filters_count > 0 %}
                        <span class="badge rounded-pill text-bg-light">{{ active_filters_count }}</span>
                    {% endif %}
                </button>

                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#legendModal">
                    Legend
                </button>
            </div>
        </div>

        <div class="col-md-6 text-md-end">
            <input id="search-text-field" v-model="state.search.text" class="my-1" type="text" placeholder="Search"> {# TODO #}
        </div>
    </div>

    <div id="data-table-container-closest">
        <table id="artisans" class="table table-striped table-sm table-hover">
            <thead class="table-dark">
            <tr>
                <th class="name text-start">Fursuit maker /&nbsp;studio name</th>
                {% for column_id, column in columns %}
                    <th class="{{ column_id }} {{ column.alignment_class }} {% if not column.default_visibility %}d-none{% endif %}">
                        {{ column.label }}
                    </th>
                {% endfor %}
            </tr>
            </thead>

            {% macro card_open_attrs(maker_id) %}
                hx-get="{{ path('htmx_main_creator_card', {makerId: maker_id}) }}"
                hx-target="#artisanDetailsModal"
                hx-trigger="click"
                data-bs-toggle="modal"
                data-bs-target="#artisanDetailsModal"
            {% endmacro %}

            <tbody>
            {% for creator in creators %}
                {% set creator_idx = loop.index %}
                <tr class="{% if creator.inactiveReason %}inactive{% endif %}"
                    {% if creator.makerId %}id="{{ creator.makerId }}"{% endif %}
                    {# TODO 'matched-maker-id': matchedMakerId(creator) #}
                >
                    <td class="name"
                        {{ _self.card_open_attrs(creator.lastMakerId) }}
                    >
                        <span class="flag-icon flag-icon-{{ creator.country|lower }}"></span>

                        &nbsp;{{- creator.name -}}

                        {%- if creator.inactiveReason -%}
                            &nbsp;[hidden] {# grep-inactive-mark #}
                        {%- endif -%}

                        <span class="text-nowrap">
                            &nbsp;{{- creator|ages_description(false) }}

                            {% if is_new(creator) %}
                                <span class="new-artisan"><i class="fa-solid fa-leaf"></i>&nbsp;recently added</span>
                            {% endif %}
                        </span>
                    </td>

                    <td class="makerId {% if not columns.makerId.default_visibility %}d-none{% endif %}"
                        {{ _self.card_open_attrs(creator.lastMakerId) }}
                    >
                        {{ creator.makerId }}
                    </td>

                    <td class="state {% if not columns.state.default_visibility %}d-none{% endif %}"
                        {{ _self.card_open_attrs(creator.lastMakerId) }}
                    >
                        {{ creator.state }}
                    </td>

                    <td class="languages {% if not columns.languages.default_visibility %}d-none{% endif %}"
                        {{ _self.card_open_attrs(creator.lastMakerId) }}
                    >
                        {{ creator.languages|join(', ') }}
                    </td>

                    <td  class="productionModels {% if not columns.productionModels.default_visibility %}d-none{% endif %}"
                        {{ _self.card_open_attrs(creator.lastMakerId) }}
                    >
                        {{ creator.productionModels|join(', ') }}
                    </td>

                    <td class="styles {% if not columns.styles.default_visibility %}d-none{% endif %}"
                        {{ _self.card_open_attrs(creator.lastMakerId) }}
                    >
                        {{ comma_separated_other(creator.styles, creator.otherStyles) }}
                    </td>

                    <td class="types {% if not columns.types.default_visibility %}d-none{% endif %}"
                        {{ _self.card_open_attrs(creator.lastMakerId) }}
                    >
                        {{ comma_separated_other(creator.orderTypes, creator.otherOrderTypes) }}
                    </td>

                    <td class="features {% if not columns.features.default_visibility %}d-none{% endif %}"
                        {{ _self.card_open_attrs(creator.lastMakerId) }}
                    >
                        {{ comma_separated_other(creator.features, creator.otherFeatures) }}
                    </td>


                    <td class="species {% if not columns.species.default_visibility %}d-none{% endif %}"
                        {{ _self.card_open_attrs(creator.lastMakerId) }}
                    >
                        {% if creator.hasSpeciesInfo %}
                            <ul>
                                {% for item in creator.speciesDoes %}
                                    <li class="yes"><i class="fas fa-check"></i>&nbsp;{{ item }}</li>
                                {% endfor %}

                                {% for item in creator.speciesDoesnt %}
                                    <li class="no"><i class="fas fa-times"></i>&nbsp;{{ item }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </td>

                    <td class="commissions {% if not columns.commissions.default_visibility %}d-none{% endif %}"
                        {{ _self.card_open_attrs(creator.lastMakerId) }}
                    >
                        {% if creator.isTracked %}
                            <ul>
                                {% if creator.csTrackerIssue %}
                                    <li class="inaccurate">
                                        <i class="far fa-question-circle"></i>&nbsp;{{ get_cst_issue_text(creator) }}
                                    </li>
                                {% endif %}

                                {% for item in creator.openFor %}
                                    <li class="yes">
                                        <i class="fas fa-check"></i>&nbsp;{{ item }}
                                    </li>
                                {% endfor %}

                                {% for item in creator.closedFor %}

                                    <li class="no">
                                        <i class="fas fa-times"></i>&nbsp;{{ item }}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </td>

                    <td class="links {% if not columns.links.default_visibility %}d-none{% endif %}">
                        <div class="btn-group artisan-links" role="group" aria-label="Links to websites">
                            {% if isDevEnv() %}
                                <a class="btn btn-warning"
                                   href="{{ path('mx_artisan_edit', { makerId: creator.lastMakerId }) }}">
                                    <i class="fas fa-edit"></i>
                                </a>
                            {% endif %}

                            {% if creator.fursuitReviewUrl %}
                                <a class="btn btn-secondary" href="{{ creator.fursuitReviewUrl }}" target="_blank">
                                    <i class="fas fa-balance-scale"></i>
                                </a>
                            {% endif %}

                            <a class="btn btn-secondary" href="{{ ab_search_uri(creator) }}" target="_blank">
                                <i class="fa-solid fa-spell-check"></i>
                            </a>

                            {% if creator.websiteUrl %}
                                <a class="btn btn-secondary" href="{{ creator.websiteUrl }}" target="_blank">
                                    <i class="fas fa-link"></i>
                                </a>
                            {% endif %}

                            <div class="btn-group" role="group">
                                <button id="drpdwnmn{{ creator_idx }}" type="button"
                                        class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown"
                                        aria-expanded="false"></button>

                                <ul class="dropdown-menu" aria-labelledby="drpdwnmn{{ creator_idx }}">
                                    {% set links = [
                                        {uri: creator.fursuitReviewUrl, icon_class: 'fas fa-balance-scale',    label: 'FursuitReview'},
                                        {uri: creator.websiteUrl,       icon_class: 'fas fa-link',             label: 'Official website'},
                                        {uri: ab_search_uri(creator),   icon_class: 'fa-solid fa-spell-check', label: 'Check on Artists Beware'},
                                    ] + creator.pricesUrls|map(u => {uri: u, icon_class: 'fas fa-dollar-sign', label: 'Prices'}) + [
                                        {uri: creator.faqUrl,           icon_class: 'fas fa-comments',         label: 'FAQ'},
                                        {uri: creator.queueUrl,         icon_class: 'fas fa-clipboard-list',   label: 'Queue'},
                                        {uri: creator.furAffinityUrl,   icon_class: 'fas fa-image',            label: 'FurAffinity'},
                                        {uri: creator.deviantArtUrl,    icon_class: 'fab fa-deviantart',       label: 'DeviantArt'},
                                        {uri: creator.mastodonUrl,      icon_class: 'fa-brands fa-mastodon',   label: 'Mastodon'},
                                        {uri: creator.twitterUrl,       icon_class: 'fab fa-twitter',          label: 'Twitter'},
                                        {uri: creator.facebookUrl,      icon_class: 'fab fa-facebook',         label: 'Facebook'},
                                        {uri: creator.tumblrUrl,        icon_class: 'fab fa-tumblr',           label: 'Tumblr'},
                                        {uri: creator.youtubeUrl,       icon_class: 'fab fa-youtube',          label: 'YouTube'},
                                        {uri: creator.instagramUrl,     icon_class: 'fab fa-instagram',        label: 'Instagram'},
                                        {uri: creator.etsyUrl,          icon_class: 'fab fa-etsy',             label: 'Etsy'},
                                        {uri: creator.theDealersDenUrl, icon_class: 'fas fa-shopping-cart',    label: 'The Dealers Den'},
                                        {uri: creator.otherShopUrl,     icon_class: 'fas fa-shopping-cart',    label: 'On-line shop'},
                                        {uri: creator.furryAminoUrl,    icon_class: 'fas fa-paw',              label: 'Furry Amino'},
                                        {uri: creator.scritchUrl,       icon_class: 'fas fa-camera',           label: 'Scritch'},
                                        {uri: creator.furtrackUrl,      icon_class: 'fas fa-camera',           label: 'Furtrack'},
                                        {uri: creator.linklistUrl,      icon_class: 'fas fa-link',             label: 'List of links'},
                                    ] %}

                                    {% for link in links|filter(link => link.uri) %}
                                        <li>
                                            <a class="dropdown-item" href="{{ link.uri }}" target="_blank">
                                                <i class="{{ link.icon_class }}"></i> {{ link.label }}
                                            </a>
                                        </li>
                                    {% endfor %}

                                    {% from 'main/htmx/shared_macros.html.twig' import update_dialog_open_attrs %}

                                    <li>
                                        <a class="dropdown-item" {{ update_dialog_open_attrs(creator.lastMakerId) }}>
                                            <i class="fas fa-exclamation-triangle"></i> Data outdated/inaccurate?
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <p id="artisans-table-count" class="small">
        Displaying {{ creators|length }} out of {{ total_creators_count }} fursuit makers in the database.
    </p>
</div>
