---
- name: "Check current working branch"
  ansible.builtin.command:
    cmd: "git branch --show-current" # noqa: command-instead-of-module
  register: "deploy_host_cmd_res"
  check_mode: false
  changed_when: false

- name: "Set helper variable"
  ansible.builtin.set_fact:
    deploy_host_working_branch: "{{ deploy_host_cmd_res.stdout }}"

- name: "Merge working into prod branch"
  block:
    - name: "Checkout the prod branch"
      ansible.builtin.command:
        cmd: "git checkout {{ prod_branch | quote }}" # noqa: command-instead-of-module
      check_mode: false
      changed_when: false

    - name: "Merge the working branch into the prod branch"
      ansible.builtin.command:
        cmd: "git merge --no-edit {{ deploy_host_working_branch | quote }}" # noqa: command-instead-of-module
      changed_when: false

    - name: "Push the prod branch to origin"
      ansible.builtin.command:
        cmd: "git push origin {{ prod_branch | quote }}" # noqa: command-instead-of-module
      changed_when: true # Could show if anything actually was pushed/merged

    - name: "Checkout the working branch"
      ansible.builtin.command:
        cmd: "git checkout {{ deploy_host_working_branch | quote }}" # noqa: command-instead-of-module
      check_mode: false
      changed_when: false

    - name: "Merge the prod branch back into the working branch"
      ansible.builtin.command:
        cmd: "git merge --no-edit {{ prod_branch | quote }}" # noqa: command-instead-of-module
      changed_when: false

    - name: "Push the working branch to origin"
      ansible.builtin.command:
        cmd: "git push origin {{ deploy_host_working_branch | quote }}" # noqa: command-instead-of-module
      changed_when: false

  always:
    - name: "Make sure to switch back to the working branch"
      ansible.builtin.command:
        cmd: "git checkout {{ deploy_host_working_branch | quote }}" # noqa: command-instead-of-module
      check_mode: false
      changed_when: false
